# CAMS - 加密貨幣資產管理系統

## 系統概述

CAMS（Cryptocurrency Asset Management System）是一個專業的加密貨幣資產管理系統，為商戶提供完整的加密貨幣資產管理解決方案。

## 登入頁面

### 登入方式
  - Google 登入：
    - 支援 Google OAuth2.0 登入
    - 登入成功後自動獲取用戶 Google 帳號信息
    - 顯示 Google 圖標和「Google 登入」文字
    - 登入過程中顯示 loading 狀態
  - 管理員登入：
    - 支援用戶名密碼登入方式
    - 點擊「管理員登入」按鈕展開登入表單
    - 表單項目：
      - 用戶名：必填，顯示用戶圖標
      - 密碼：必填，顯示鎖定圖標，密碼輸入框
    - 提交按鈕：全寬度，點擊時顯示 loading 狀態

### 頁面樣式
  - 響應式設計：
    - 登入卡片固定寬度 400px
    - 垂直水平居中顯示
  - 深色模式支援：
    - 自動跟隨系統主題切換
    - 深色模式下調整背景色、文字顏色和邊框顏色
  - 視覺元素：
    - 分隔線：Google 登入與管理員登入之間顯示「或」分隔線
    - 圖標：所有按鈕和輸入框配備相應圖標
    - 錯誤提示：表單驗證錯誤時顯示紅色提示文字

### 功能邏輯
  - 表單驗證：
    - 用戶名和密碼為必填項
    - 提交前進行表單完整性檢查
  - 登入流程：
    - 登入成功：
      - 保存用戶信息到 sessionStorage
      - 自動跳轉到系統首頁
    - 登入失敗：
      - 錯誤提示類型：
        - 表單驗證錯誤：
          - 「請輸入用戶名」：用戶名為空時顯示
          - 「請輸入密碼」：密碼為空時顯示
          - 「請填寫所有必填項」：提交時存在未填寫的必填項
        - 帳號驗證錯誤：
          - 「用戶名或密碼錯誤」：驗證失敗時顯示
          - 「帳號已被鎖定」：多次登入失敗後顯示
          - 「帳號已停用」：帳號狀態異常時顯示
        - Google 登入錯誤：
          - 「Google 登入失敗」：OAuth 驗證失敗時顯示
          - 「Google 帳號未綁定」：首次使用 Google 登入時顯示
          - 「網絡連接異常」：無法連接 Google 服務時顯示
        - 系統錯誤：
          - 「系統維護中」：系統維護時顯示
          - 「服務暫時不可用」：系統異常時顯示
          - 「請稍後重試」：臨時性錯誤時顯示
      - 顯示錯誤提示信息
      - 保持在登入頁面

### 安全措施
  - 密碼輸入：使用密碼型輸入框，隱藏實際輸入內容
  - 表單提交：使用 HTTPS 加密傳輸
  - Session 管理：登入成功後使用 token 進行身份驗證
  - Session 過期時間：1天，若期間有進行任何操作，則自動延長1天，最長可延長至14天

## 監控管理

### 數據監控
  - 平台選擇：支持按不同平台（如 Fameex、CNX）進行數據篩選，選項內容來自於 **參數管理.商戶管理**
  - 今日數據卡片：
    - 今日存款總額：以 USDT 為單位顯示今日存款總金額，計算公式：**sum(今日充值訂單.USDT價值)**
    - 平均存款時長：顯示今日存款訂單的平均處理時間，計算公式：**average(今日充值訂單.處理時間)**
    - 今日提款總額：以 USDT 為單位顯示今日提款總金額，計算公式：**sum(今日提現訂單.USDT價值)**
    - 平均提款時長：顯示今日提款訂單的平均處理時間，計算公式：**average(今日提現訂單.處理時間)**
  - 幣種分佈分析：
    - 存款幣種佔比：以圓餅圖展示各幣種存款金額佔比
    - 提款幣種佔比：以圓餅圖展示各幣種提款金額佔比
  - 鏈上處理時長：
    - 存款時長分析：以柱狀圖展示各幣種的平均存款處理時長
    - 提款時長分析：以柱狀圖展示各幣種的平均提款處理時長
  - 小時趨勢分析：
    - 24小時存提款趨勢：以折線圖展示24小時內存款和提款金額的變化趨勢，每小時一個數據點，數據來自於 **今日充值訂單每小時加總** 和 *今日提現訂單每小時加總**
    - 支持按小時查看詳細數據

### 告警監控
  - 告警統計：
    - 統計維度：
      - 節點高度告警：顯示30分鐘內、30-60分鐘、60分鐘以上的告警數量
      - 提幣時長告警：顯示30分鐘內、30-60分鐘、60分鐘以上的告警數量
      - 大額交易告警：顯示30分鐘內、30-60分鐘、60分鐘以上的告警數量
      - 未確認轉帳：顯示30分鐘內、30-60分鐘、60分鐘以上的告警數量
      - 錢包水位告警：顯示30分鐘內、30-60分鐘、60分鐘以上的告警數量
      - 錢包異常告警：顯示30分鐘內、30-60分鐘、60分鐘以上的告警數量
      - 風險地址告警：顯示30分鐘內、30-60分鐘、60分鐘以上的告警數量

  - 節點高度告警：
    - 告警規則設置：
      - 支持多條規則配置
      - 規則類型：服務高度延遲、節點高度延遲
      - 閾值設置：區塊數差異閾值
      - 持續時間：觸發告警的持續時間（分鐘）
    - 顯示內容：
      - 鏈名稱、服務高度、節點高度、鏈上高度
      - 高度差異：顯示服務高度與節點高度、節點高度與鏈上高度的差值
      - 告警原因：高度延遲的具體描述

  - 提幣時長告警：
    - 告警規則設置：
      - 處理中訂單超時時間（分鐘）
      - 等待中訂單超時時間（分鐘）
      - 通知超時時間（分鐘）
    - 顯示內容：
      - 商戶、訂單ID（可點擊跳轉）、幣鏈、幣種
      - 創建時間、告警原因
      - 狀態標記：使用不同顏色區分處理中和等待中

  - 大額交易告警：
    - 告警規則設置：
      - 存款閾值（USDT）
      - 提款閾值（USDT）
    - 顯示內容：
      - 商戶、訂單ID（可點擊跳轉）、幣鏈、幣種
      - 金額、USDT價值、用戶ID
      - 操作按鈕：確認按鈕（需填寫確認原因）

  - 未確認轉帳告警：
    - 未確認轉帳定義：
      - 當**訂單管理.轉帳訂單**生成時，但無法匹配為特定類型，則視為未確認
    - 顯示內容：
      - 轉帳ID（可點擊跳轉）、錢包ID
      - 幣鏈、幣種、轉帳金額、時間

  - 錢包水位告警：
    - 告警規則設置：
      - 水位告警閾值：
        - 危險水位：低於20%時告警（紅色）
        - 警告水位：低於50%時告警（黃色）
      - 支持每個商戶單獨配置不同的告警閾值
    - 顯示內容：
      - 商戶、錢包ID、錢包類型
      - 當前餘額、存儲上限、剩餘水位
      - 水位顏色：
        - 紅色：低於危險水位
        - 黃色：低於警告水位
        - 綠色：高於警告水位

  - 錢包異常告警：
    - 告警效果：
      - 告警的錢包暫時停止任何轉帳操作
      - 操作解鎖後，錢包恢復正常
      - 操作鎖定後，錢包轉換至已禁用狀態，並新增狀態變更記錄，變更原因為操作時輸入的原因
    - 告警規則設置：
      - 轉帳失敗次數閾值
      - 確認超時時間（分鐘）
    - 顯示內容：
      - 錢包ID、錢包類型、幣鏈、幣種
      - 異常原因、時間
      - 操作按鈕：支持解鎖/鎖定錢包（需填寫操作原因）

  - 風險地址告警：
    - 告警效果：
      - 告警的地址暫時停止任何轉帳操作
      - 告警時該筆轉帳不建立充值訂單
      - 操作解鎖後，地址恢復正常
      - 操作解鎖後，重新生成充值訂單
      - 操作鎖定後，地址轉換至已停用狀態，並新增狀態變更記錄，變更原因為操作時輸入的原因，當相同UID請求地址時，重新生成新地址
    - 顯示內容：
      - 商戶名稱、平台（Fameex/CNX）
      - 幣鏈、幣種、交易金額
      - 來源地址、目標地址（支持一鍵複製）
      - 用戶ID、風險等級
      - 告警時間、告警原因
      - 操作按鈕：
        - 放行：允許交易繼續（需填寫審核意見）
        - 鎖定：變更錢包狀態為已停用
        
  - 通用功能：
    - 分頁顯示：每頁顯示5條記錄
    - 表格排序：支持按時間排序
    - 表格滾動：水平滾動支持
    - 深色模式：完整支持深色模式顯示

### 節點高度監控
  - 頁面佈局：
    - 標題欄：顯示「節點高度監控」標題和重新整理按鈕
    - 表格區域：以表格形式展示節點高度數據
  - 表格內容：
    - 鏈類型：顯示區塊鏈類型名稱
    - 節點區塊高度：
      - 顯示節點當前區塊高度
      - 當與最新高度有差異時，顯示差值（紅色）
      - 支援按差值大小排序
    - 資料庫區塊高度：
      - 顯示資料庫當前區塊高度
      - 當與最新高度有差異時，顯示差值（紅色）
      - 支援按差值大小排序
    - 鏈上最新高度：顯示區塊鏈網路最新高度
    - 更新時間：顯示數據更新時間，格式為 YYYY-MM-DD HH:mm:ss
  - 功能特性：
    - 分頁功能：每頁顯示10筆記錄
    - 排序功能：
      - 支援按節點區塊高度差值排序
      - 支援按資料庫區塊高度差值排序
      - 點擊表頭可切換升序/降序
    - 表格滾動：支援水平滾動（1200px）
    - 重新整理：點擊按鈕重新載入最新數據
  - 數據獲取：
    - 往後端發起請求後，從DB撈取最新的數據回傳
    - 回傳格式範例：
      ```json
      {
        "code": 200,
        "data": {
          "total": 4,
          "list": [
            {
              "chain": "BTC",
              "nodeHeight": 828392,
              "nodeHeightDiff": 2, 
              "dbHeight": 828390,
              "dbHeightDiff": 4,
              "latestHeight": 828394,
              "updateTime": "2024-03-21 14:30:22"
            },
            {
              "chain": "ETH", 
              "nodeHeight": 19234821,
              "nodeHeightDiff": 1,
              "dbHeight": 19234820,
              "dbHeightDiff": 2,
              "latestHeight": 19234822,
              "updateTime": "2024-03-21 14:30:21"
            }
          ]
        },
        "message": "success"
      }
      ```

### 節點高度數據獲取方式
  - 該模塊為自動查詢高度數據並存入DB，
:::mermaid
flowchart TD
A[後端每5分鐘發送請求] --> B[MQTT]
B --> C1[CRYP-BTC服務監聽]
B --> C2[CRYP-ETH服務監聽]
B --> C3[CRYP-TRX服務監聽]
B --> C4[CRYP-BSC服務監聽]
C1 --> D1[查詢BTC高度]
C2 --> D2[查詢ETH高度]
C3 --> D3[查詢TRX高度]
C4 --> D4[查詢BSC高度]
D1 --> E1[回傳MQTT]
D2 --> E2[回傳MQTT]
D3 --> E3[回傳MQTT]
D4 --> E4[回傳MQTT]
E1 --> F[後台接收]
E2 --> F
E3 --> F
E4 --> F
F --> G[儲存DB]
:::

## 錢包管理
### 錢包查詢
- **功能說明**：提供錢包信息的多維度查詢功能
- **查詢條件**：
  - 商戶：選擇特定商戶
  - 鏈類型：選擇區塊鏈網絡類型
  - 幣種：選擇代幣類型
  - 錢包地址：輸入完整或部分地址進行模糊查詢
- **列表展示**：
  - 錢包ID：唯一標識符，建議生成結構 {商戶代號}{錢包類型}{6位流水號}
  - 商戶：所屬商戶
  - 用戶ID：關聯用戶
  - 錢包類型：錢包分類
  - 鏈類型：所屬區塊鏈
  - 幣種：代幣類型
  - 錢包地址：顯示縮略地址，支持一鍵複製
  - 資產價值：根據金額大小顯示不同顏色
    - 十億以上：紅色
    - 百萬到億：橙色
    - 個位到十萬：綠色
    - 小數部分：灰色
  - 狀態：啟用/禁用/停用狀態標籤
  - 操作：
    - 查看詳情：跳轉至錢包明細頁面，並帶入該錢包的搜尋條件
    - 發起轉賬：跳轉至錢包轉帳頁面，並帶入該錢包毀尋條件至轉出錢包資訊
- **新增錢包**：
  - 必填信息：
    - 鏈類型
    - 錢包類型：僅允許新增外轉錢包
    - 地址（僅外轉錢包需要）

### 錢包類型及轉帳說明
- 錢包類型說明
  - 用戶錢包：經用商戶透過API所建立的錢包
  - 項目方錢包：經由後台人員操作所更改的類型，若錢包的類型為此，不參與後續的歸集行為，代幣僅保留於此錢包中，且後續若相同用戶ID提幣時，僅由這個錢包出款
  - 歸集錢包：用於歸集用戶錢包所收到的代幣
  - 出款錢包：用戶申請提現時，出款的錢包
  - 外轉錢包：用於人工操作轉帳時的目標錢包，任何自動化操作都略過此錢包(包含餘額查詢等)
- 錢包自動型行為說明
  - 餘額查詢：
    - 當生成一筆轉帳單時，觸發查詢餘額的行為
    - 當於**錢包詳情.操作.刷新餘額**操作時，觸發查詢餘額行為
    - 每日進行**對帳功能**時，觸發查詢餘額行為
  - 歸集行為：
    - 每當用戶錢包生成轉帳單時，檢查餘額是否高於儲存上限，若是則進行歸集
    - 歸集觸發時，檢查錢包所需轉帳的主幣是否充足，若不足則依該合約幣所定義的手續費量，由歸集錢包轉帳符合用量的手續幣主幣；若充足則直接建立歸集轉帳
    :::mermaid
    flowchart TD
    A[用戶錢包生成轉帳單] --> B{檢查餘額是否超過儲存上限}
    B -->|否| C[結束流程]
    B -->|是| D{檢查主幣餘額是否充足}
    D -->|是| E[建立歸集轉帳]
    D -->|否| F[歸集錢包轉入手續費]
    F -->|每5分鐘監控| D
    E --> H[結束流程]
    :::

### 錢包詳情
- **功能說明**：提供錢包詳細資訊的查看功能
- **查詢條件**：
  - 商戶：下拉選擇商戶
  - 鏈類型：下拉選擇區塊鏈類型
  - 幣種：下拉選擇代幣類型
  - 錢包地址：輸入完整地址進行查詢
- **錢包資訊**：
  - 錢包ID：唯一標識符
  - 地址：完整地址，支持一鍵複製
  - 鏈類型：所屬區塊鏈
  - 商戶：所屬商戶
  - 用戶ID：關聯用戶
  - 錢包類型：[類型說明](#錢-包-類-型-及-轉-帳-說-明)，支持變更類型及查看變更歷史
    - 變更類型：
      - 點擊編輯按鈕開啟變更類型視窗
      - 選擇新的錢包類型，有限制規則
        - 原始類型為**用戶錢包**，可更改類型為**項目方錢包**
        - 原始類型為**項目方錢包**，可更改類型為**用戶錢包**
        - 其它類型錢包不支持變更
      - 必須填寫變更原因
      - 確認後更新錢包類型
    - 變更歷史：點擊歷史按鈕可查看變更記錄，包含：
      - 操作時間：變更時間
      - 操作人：執行變更的人員
      - 變更原因：變更類型的原因說明
      - 變更前狀態：原始錢包類型
      - 變更後狀態：變更後的錢包類型
  - 狀態：啟用/禁用，支持變更狀態及查看變更歷史
    - 變更狀態：
      - 點擊編輯按鈕開啟變更狀態視窗
      - 選擇新的狀態(啟用/禁用)，狀態影響錢包說明如下
        - 啟用：正常
        - 禁用：禁止任何型式轉帳
        - 棄用：不參與自動歸集，可人工轉帳，且不可恢復；當商戶請求地址，該USERID有對應錢包但狀態為棄用，則新建新的錢包
      - 必須填寫變更原因
      - 確認後更新錢包狀態
    - 變更歷史：點擊歷史按鈕可查看變更記錄，包含：
      - 操作時間：變更時間
      - 操作人：執行變更的人員
      - 變更原因：變更狀態的原因說明
      - 變更前狀態：原始錢包狀態
      - 變更後狀態：變更後的錢包狀態
  - 私鑰管理：
    - 下載私鑰：
      - 點擊下載按鈕開啟下載私鑰視窗
      - 必須填寫下載原因，最多200字
      - 確認後下載私鑰文件
    - 下載歷史：點擊歷史按鈕可查看下載記錄，包含：
      - 下載時間：執行下載的時間
      - 下載原因：下載私鑰的原因說明
      - 操作人：執行下載的人員
- **代幣詳情**：
  - 幣種：代幣類型
  - 當前餘額：
      - 當前餘額：該幣種於錄上的餘額
      - 樣式說明：當餘額數字大於儲存上限，則加上紅色底色
  - 持有成本單價/持有成本：[代幣持有成本算法](#代-幣-持-有-成-本-算-法)
  - 資產價值：當前持有數量乘以當前市場價格
  - 當前&可用轉入/轉出量：顯示可用轉入及轉出量，當前有轉入量時顯示綠色背景，當前有轉出量時顯示橙色背景
    - 當前轉入量 = 已建立的轉帳單，此錢包為轉入地址，且狀態非成功或失敗的數量加總
    - 可用轉入量 = 儲存上限 - 當前餘額 + 當前轉入量
    - 當前轉出量 = 已建立的轉帳單，此錢包為轉出地址，且狀態非成功或失敗的數量加總
    - 可用轉出量 = 當前餘額 - 當前轉入量 - 當前轉出量
  - 最後交易時間：最後一筆交易時間
  - 支持搜尋幣種及排序功能
  - 操作：
    - 轉帳歷史：點擊開啟轉帳歷史彈窗，查看該代幣的轉帳記錄，預設展示近24小時資料，[欄位說明](#轉-帳-訂-單-查-詢)
    - 交易明細：點擊開啟交易明細彈窗，查看該代幣的交易明細，預設展示近24小時資料，[欄位說明](#交-易-明-細-查-詢)
    - 刷新餘額：點擊刷新該代幣的餘額，刷新時顯示 loading 狀態

### 代幣持有成本算法
代幣持有成本採用加權平均計算方式，主要變數如下：

- $C_{\text{prev}}$：前一次交易後的總持有成本 (USDT)
- $Q_{\text{prev}}$：前一次交易後的總持有數量 (ETH)
- $P_{\text{new}}$：新買入或賣出的單價 (USDT/ETH)
- $Q_{\text{new}}$：新買入或賣出的數量 (ETH)
- $C_{\text{new}}$：新的總持有成本 (USDT)
- $Q_{\text{new total}}$：新的總持有數量 (ETH)
- $A_{\text{new}}$：新的平均持有成本 (USDT/ETH)

#### 買入時計算公式

1. 新總成本 = 原總成本 + (新單價 × 新數量)
   $C_{\text{new}} = C_{\text{prev}} + (P_{\text{new}} \times Q_{\text{new}})$

2. 新總數量 = 原總數量 + 新數量
   $Q_{\text{new total}} = Q_{\text{prev}} + Q_{\text{new}}$

3. 新平均成本 = 新總成本 ÷ 新總數量
   $A_{\text{new}} = \frac{C_{\text{new}}}{Q_{\text{new total}}}$

#### 賣出時計算公式

1. 新總成本 = 原總成本 - (原平均成本 × 賣出數量)
   $C_{\text{new}} = C_{\text{prev}} - (\frac{C_{\text{prev}}}{Q_{\text{prev}}} \times Q_{\text{new}})$

2. 新總數量 = 原總數量 - 賣出數量
   $Q_{\text{new total}} = Q_{\text{prev}} - Q_{\text{new}}$

3. 新平均成本 = 新總成本 ÷ 新總數量 (若持有數量 > 0)
   $A_{\text{new}} = \frac{C_{\text{new}}}{Q_{\text{new total}}}$

#### 計算範例

初始條件:
- 第一筆: 1000 USDT 買入 0.25 ETH (單價 4000 USDT/ETH)
- 第二筆: 1500 USDT 買入 0.2 ETH (單價 7500 USDT/ETH)
- 第三筆: 1250 USDT 買入 0.5 ETH (單價 2500 USDT/ETH)
- 第四筆: 賣出 0.5 ETH，獲得 2000 USDT

計算過程:
1. 第一筆交易後:
   - 總成本 = 1000 USDT
   - 總數量 = 0.25 ETH
   - 平均成本 = 4000 USDT/ETH
   
   $C_{\text{new}} = 1000$
   
   $Q_{\text{new total}} = 0.25$
   
   $A_{\text{new}} = \frac{1000}{0.25} = 4000 \text{ USDT/ETH}$

2. 第二筆交易後:
   - 總成本 = 2500 USDT
   - 總數量 = 0.45 ETH
   - 平均成本 = 5555.56 USDT/ETH
   
   $C_{\text{new}} = 1000 + 1500 = 2500$
   
   $Q_{\text{new total}} = 0.25 + 0.2 = 0.45$
   
   $A_{\text{new}} = \frac{2500}{0.45} = 5555.56 \text{ USDT/ETH}$

3. 第三筆交易後:
   - 總成本 = 3750 USDT
   - 總數量 = 0.95 ETH
   - 平均成本 = 3947.37 USDT/ETH
   
   $C_{\text{new}} = 2500 + 1250 = 3750$
   
   $Q_{\text{new total}} = 0.45 + 0.5 = 0.95$
   
   $A_{\text{new}} = \frac{3750}{0.95} = 3947.37 \text{ USDT/ETH}$

4. 第四筆交易後:
   - 總成本 = 1776.32 USDT
   - 總數量 = 0.45 ETH
   - 平均成本 = 3947.37 USDT/ETH
   
   $C_{\text{new}} = 3750 - \left(\frac{3750}{0.95} \times 0.5\right) = 1776.32$
   
   $Q_{\text{new total}} = 0.95 - 0.5 = 0.45$
   
   $A_{\text{new}} = \frac{1776.32}{0.45} = 3947.37 \text{ USDT/ETH}$

#### 買入/賣出定義
- 當來源地址非任一系統地址，則按當下的價格做為買入計算
- 當來源地址為任一系統地址，則按來源地址的成本單價為買入計算
- 當轉出地址非任一系統地址，則按當下的價格做為賣出計算
- 當轉出地址為任一系統地址，則按原持有的成本單價為賣出計算

### 錢包轉賬
- **功能說明**：提供錢包間資金轉移功能
:::mermaid
flowchart TD
    A[建立轉帳申請] --> B[建立轉帳單]
    B --> C{審核結果}
    C -->|通過| D[轉帳單執行]
    D --> E[檢查餘額]
    E -->|餘額充足| F[執行轉帳]
    E -->|餘額不足| G[轉帳失敗]
    F --> H{轉帳結果}
    H -->|成功| I[轉帳完成]
    H -->|失敗| G
    C -->|拒絕| J[轉帳單失敗]
:::
- **轉出錢包資訊**：
  - 商戶：下拉選擇商戶
  - 鏈類型：下拉選擇區塊鏈類型
  - 幣種：下拉選擇代幣類型
  - 錢包地址：輸入完整地址進行查詢
  - 查詢按鈕：點擊查詢錢包詳情
- **轉出錢包詳情**：
  - 幣種：代幣類型
  - 當前餘額：錢包餘額
  - 可轉出餘額：可用於轉出的餘額[資料來源：可用轉出量](#錢-包-詳-情)
- **轉入錢包資訊**：
  - 商戶：下拉選擇商戶
  - 鏈類型：下拉選擇區塊鏈類型
  - 幣種：下拉選擇代幣類型
  - 錢包地址：輸入完整地址進行查詢
  - 查詢按鈕：點擊查詢錢包詳情
- **轉入錢包詳情**：
  - 幣種：代幣類型
  - 當前餘額：錢包餘額
  - 可轉入餘額：可用於轉入的餘額[資料來源：可用轉出量](#錢-包-詳-情)
- **轉賬資訊**：
  - 轉賬金額：輸入轉賬數量
  - 最大金額：勾選使用最大可轉出金額
  - 轉賬按鈕：點擊建立轉賬申請，彈窗顯示以下內容：
    - 轉出錢包資訊：商戶、鏈類型、幣種、地址
    - 轉賬金額
    - 轉入錢包資訊：商戶、鏈類型、幣種、地址
    - 確認按鈕：提交轉賬申請
    - 取消按鈕：關閉彈窗
- **轉賬申請查詢**：
  - 查詢條件：
    - 商戶：選擇商戶
    - 鏈類型：選擇區塊鏈類型
    - 幣種：選擇代幣類型
    - 錢包類型：選擇錢包類型
    - 錢包地址：輸入地址
  - 列表展示：
    - 支持分頁查詢
    - 支持審核操作
    - 支持查看審核詳情
    - 欄位說明：
      - 轉出錢包地址：顯示轉出方錢包地址
      - 轉出鏈類型：顯示轉出方區塊鏈類型
      - 轉出幣種：顯示轉出方代幣類型
      - 轉賬金額：顯示轉賬數量
      - 轉入商戶：顯示轉入方商戶名稱
      - 轉入錢包地址：顯示轉入方錢包地址
      - 轉入鏈類型：顯示轉入方區塊鏈類型
      - 轉入幣種：顯示轉入方代幣類型
      - 建立時間：顯示轉賬申請建立時間
      - 審核時間：顯示審核完成時間
      - 審核狀態：顯示待審核/已通過/已拒絕
      - 轉賬狀態：顯示已提交/上鏈中/確認中(x/y)/已完成/失敗[狀態說明](#轉-帳-訂-單-查-詢)
      - 操作：
        - 待審核狀態顯示「審核」按鈕，點擊彈窗顯示：
          - 審核操作：下拉選擇「通過」或「拒絕」
          - 審核原因：輸入審核意見
          - 確認按鈕：提交審核結果，並使該筆轉帳單進行執行
          - 取消按鈕：關閉彈窗
        - 已審核狀態顯示「詳情」按鈕，點擊彈窗顯示：
          - 審核操作：顯示「通過」或「拒絕」
          - 審核原因：顯示審核意見

### 代幣兌換
- **功能說明**：提供不同代幣間的兌換功能
:::mermaid
flowchart TD
    A[申請代幣兌換] -->|訂單狀態: 待處理| B{進行審核}
    B -->|不通過| C[已拒絕]
    B -->|通過| D[建立轉帳單]
    D -->|訂單狀態: 轉出中| E{轉帳結果}
    E -->|失敗| F[轉出失敗]
    E -->|成功| G[調用交易所API交易]
    G -->|訂單狀態: 兌換中| H{交易結果}
    H -->|失敗| I[兌換失敗]
    H -->|成功| J[調用交易所API提幣]
    J -->|訂單狀態: 轉入中| K[轉入錢包接收交易]
    K --> L[建立轉帳單]
    L -->|訂單狀態: 兌換成功| M[完成]
:::
- **兌出錢包資訊**：
  - 商戶：下拉選擇商戶
  - 鏈類型：下拉選擇區塊鏈類型，若兌入已選擇非USDT幣種，則只提供支持USDT幣種的鏈類型
  - 幣種：下拉選擇代幣類型，若兌入已擇擇非USDT幣種，則只提供USDT選項
  - 錢包地址：輸入完整地址進行查詢
  - 查詢按鈕：點擊查詢錢包詳情
- **兌出錢包詳情**：
  - 幣種：代幣類型
  - 當前餘額：錢包餘額
  - 可兌出餘額：可用於兌換的餘額[資料來源：可用轉出量](#錢-包-詳-情)
- **兌入錢包資訊**：
  - 商戶：下拉選擇商戶
  - 鏈類型：下拉選擇區塊鏈類型，若兌出已選擇非USDT幣種，則只提供支持USDT幣種的鏈類型
  - 幣種：下拉選擇代幣類型，若兌入已擇擇非USDT幣種，則只提供USDT選項
  - 錢包地址：輸入完整地址進行查詢
  - 查詢按鈕：點擊查詢錢包詳情
- **兌入錢包詳情**：
  - 幣種：代幣類型
  - 當前餘額：錢包餘額
  - 可兌入餘額：可用於兌入的餘額[資料來源：可用轉出量](#錢-包-詳-情)
- **兌換資訊**：
  - 兌換金額：輸入兌換數量
  - 最大金額：勾選使用最大可兌換金額
  - 兌換平台：下拉選擇兌換平台(Binance/MEXC/Gate.io)
    - 根據所選擇的兌出、兌入，展示可支持該幣對的交易所選項
  - 兌換匯率：顯示當前兌換匯率，即USDT單價
  - 預計收到：顯示預計收到的代幣數量
  - 兌換按鈕：點擊建立兌換申請，彈窗顯示以下內容：
    - 兌出錢包資訊：商戶、鏈類型、幣種、地址、兌換金額
    - 兌入錢包資訊：商戶、鏈類型、幣種、地址、預計收到金額
    - 兌換資訊：兌換平台、兌換匯率
    - 確認按鈕：提交兌換申請
    - 取消按鈕：關閉彈窗
- **兌換審核列表**：
  - 列表展示：
    - 支持分頁查詢
    - 支持審核操作
    - 欄位說明：
      - 兌出錢包地址：顯示兌出方錢包地址
      - 兌出幣種：顯示兌出方代幣類型
      - 兌換金額：顯示兌換數量
      - 兌換平台：顯示兌換平台名稱
      - 兌換匯率：顯示兌換匯率
      - 兌入錢包地址：顯示兌入方錢包地址
      - 兌入幣種：顯示兌入方代幣類型
      - 預計收到：顯示預計收到金額
      - 兌換狀態：
        - 待處理：已建立的兌幣訂單，未經過審核
        - 轉出中：已通過審核，並建立轉帳單執行
        - 兌換中：轉帳單已完成，目標交易所已到帳
        - 轉入中：於目標交易所完成交易，並發起提幣成功
        - 兌換成功：兌入地址收到對應的交易且建立轉帳單為成功
        - 轉出失敗：在轉出中的節點因故轉出失敗
        - 兌換失敗：在目標交易所無法正常交易兌換
        - 已拒絕：審核拒絕
      - 建立時間：顯示兌換申請建立時間
      - 操作：
        - 待審核狀態顯示「審核」按鈕，點擊彈窗顯示：
          - 審核操作：下拉選擇「通過」或「拒絕」
          - 審核原因：輸入審核意見
          - 確認按鈕：提交審核結果
          - 取消按鈕：關閉彈窗

## 訂單管理
### 所有訂單生成流程
:::mermaid
flowchart TD
    A[CRYP通知交易明細] --> B[建立轉帳單]
    B --> C{轉帳單類型}
    C -->|充值類型| D[建立充值訂單]
    C -->|提現類型| E[更新提現訂單]
    C -->|轉帳類型| F[更新轉帳訂單]
    C -->|兌換類型| G[更新兌換訂單]
    D --> H[通知商戶]
    E --> H
:::
### 充值訂單查詢
  - 查詢條件：
    - 商戶選擇：支持選擇指定商戶進行查詢
    - 訂單狀態：支持按訂單狀態篩選
    - 日期範圍：支持選擇時間區間查詢
    - 訂單編號：支持輸入訂單編號進行查詢
    - 錢包地址：支持輸入充值錢包地址進行查詢
    - 交易哈希：支持輸入交易哈希值進行查詢
    - 用戶ID：支持輸入用戶ID進行查詢
  - 列表展示：
    - 支持分頁查詢
    - 每頁顯示20筆資料
    - 欄位說明：
      - 商戶：顯示商戶名稱
      - 平台訂單號：平台內部訂單編號
      - 商戶訂單號：商戶提供的訂單編號
      - 轉帳單號：區塊鏈轉帳編號
      - 交易哈希：區塊鏈交易哈希值
      - 充值金額：原始充值金額
      - USDT價值：換算為USDT的等值金額，資料來源為[轉帳訂單](#轉-帳-訂單)
      - 收款地址：充值目標地址
      - 訂單狀態：顯示當前訂單狀態
        - 確認中(confirming)：確認數未達上帳確認數，顯示格式為 確認中(x/y/z)
          - x：為目前的確認數
          - y：為區塊鏈管理中定義的上帳確認數
          - z：為區塊鏈管理中定義的解鎖確認數
        - 處理中(processing)：交易已提交至區塊鏈，等待確認
        - 等待中(waiting)：訂單已建立，等待處理
        - 重試中(retrying)：交易失敗後進行重試
        - 成功(success)：交易已完成且確認數達標
        - 失敗(failed)：交易失敗且重試次數已達上限
      - 通知狀態：每30秒通知一次，5分鐘超時
        - 重試中(retrying)：首次通知失敗，仍在排程通知中未達超時
        - 成功(success)：通知成功
        - 超時(timeout)：持續重試通知直到超時仍未能通知成功
          - 重試：點擊後彈出通知詳情視窗，包含:
            - 通知URL：顯示商戶回調地址，支持編輯
            - 通知內容：以JSON格式顯示通知內容，支持複製
              - 訂單編號
              - 商戶ID
              - 訂單狀態
              - 交易金額
              - 交易哈希等
            - 錯誤內容：以JSON格式顯示錯誤內容，支持複製
              - 錯誤碼
              - 錯誤訊息
              - 時間戳等
            - 操作按鈕：
              - 取消：關閉視窗
              - 重試：重新發送通知請求
      - 建立時間：訂單建立時間
      - 成功時間：訂單完成時間
      - 通知時間：商戶通知時間
        - 點擊「通知歷史」按鈕可查看通知歷史記錄
        - 通知歷史記錄包含：
          - 通知時間：每次通知的時間
          - 通知原因：觸發通知的原因，如「訂單確認」、「訂單完成」等
          - 通知結果：通知的結果，包含響應碼和響應訊息
        - 通知歷史記錄按時間倒序排列
        - 支持查看所有歷史通知記錄，每頁10筆

### 提現訂單查詢
  - 查詢條件：
    - 商戶選擇：支持選擇指定商戶進行查詢
    - 訂單狀態：支持按訂單狀態篩選
      - 確認中
      - 成功
      - 失敗
    - 日期範圍：支持選擇時間區間查詢
    - 訂單編號：支持輸入訂單編號進行查詢
    - 錢包地址：支持輸入提現錢包地址進行查詢
    - 交易哈希：支持輸入交易哈希值進行查詢
    - 用戶ID：支持輸入用戶ID進行查詢
  - 列表展示：
    - 支持分頁查詢
    - 每頁顯示20筆資料
    - 支持下載功能：可將查詢結果匯出為CSV檔案
    - 欄位說明：
      - 商戶：顯示商戶名稱
      - 訂單資訊：
        - 平台訂單號：平台內部訂單編號
        - 商戶訂單號：商戶提供的訂單編號
        - 轉帳單號：區塊鏈轉帳編號，若僅對應一筆轉帳單則直接展示訂單號，若對應多筆(因失敗重試)點擊可查看轉帳單
        - 交易哈希：區塊鏈交易哈希值，支持複製和查看區塊鏈瀏覽器
      - 提現金額：原始提現金額
      - USDT價值：換算為USDT的等值金額
      - 收款地址：提現目標地址，支持複製功能
      - 訂單狀態：顯示當前訂單狀態
        - 確認中(confirming)：確認數未達上帳確認數，顯示格式為 確認中(x/y/z)
          - x：為目前的確認數
          - y：為區塊鏈管理中定義的上帳確認數
          - z：為區塊鏈管理中定義的解鎖確認數
        - 處理中(processing)：交易已提交至區塊鏈，等待確認
        - 等待中(waiting)：訂單已建立，等待處理
        - 重試中(retrying)：交易失敗後進行重試
        - 成功(success)：交易已完成且確認數達標
        - 失敗(failed)：交易失敗且重試次數已達上限
      - 通知狀態：
        - 重試中(retrying)：首次通知失敗，仍在排程通知中未達超時
        - 成功(success)：通知成功
        - 超時(timeout)：持續重試通知直到超時仍未能通知成功
          - 重試：點擊後彈出通知詳情視窗，包含:
            - 通知URL：顯示商戶回調地址，支持編輯
            - 通知內容：以JSON格式顯示通知內容，支持複製
            - 錯誤內容：以JSON格式顯示錯誤內容，支持複製
            - 操作按鈕：
              - 取消：關閉視窗
              - 重試：重新發送通知請求
      - 時間資訊：
        - 建立時間：訂單建立時間
        - 成功時間：訂單完成時間
        - 通知時間：商戶通知時間
        - 通知歷史：點擊可查看通知歷史記錄，包含：
          - 通知時間：每次通知的時間
          - 通知原因：觸發通知的原因
          - 通知結果：通知的結果，包含響應碼和響應訊息
          - 支持查看所有歷史通知記錄，每頁10筆

### 轉帳訂單查詢
- **查詢條件**：
  - 訂單編號：支持輸入轉帳單號進行查詢
  - 錢包編號：支持輸入來源或目標錢包ID進行查詢
  - 地址：支持輸入提現錢包地址進行查詢
  - 交易哈希：支持輸入區塊鏈交易哈希查詢
  - 關聯訂單編號：支持輸入充值、提現、兌換單號進行查詢
  - 狀態：下拉選擇轉帳狀態
    - 處理中(processing)：轉帳正在處理
    - 成功(success)：轉帳已完成
    - 失敗(failed)：轉帳失敗
  - 轉帳類型：下拉選擇轉帳類型
    - 待確認(pendingConfirm)：等待確認的轉帳
    - 手續費(fee)：系統手續費轉帳
    - 人工轉入(manualIn)：人工處理的轉入
    - 存款(deposit)：用戶存款轉帳
    - 提現(withdraw)：用戶提現轉帳
    - 兌換(exchange)：幣種兌換轉帳
    - 補充(replenish)：系統補充轉帳 
  - 時間範圍：支持選擇建立時間區間查詢
- **列表展示**：
  - 支持分頁查詢，每頁10筆資料
  - 支持匯出CSV功能
  - 欄位說明：
    - 轉帳單號：系統轉帳單號
    - 來源錢包：轉出方錢包ID (若該筆為充值，則為空)
    - 目標錢包：轉入方錢包ID (若該筆為提現，則為空)
    - 轉帳類型：顯示轉帳類型及原因(若為人工，點擊彈出說明)
      - 待確認類型可修改為:
        - 人工轉出(manualOut)：人工處理的轉出
        - 人工轉入(manualIn)：人工處理的轉入
        - 系統錯誤(systemError)：系統錯誤導致的轉帳
      - 修改類型時需填寫:
        - 轉帳類型：下拉選擇新的轉帳類型
        - 修改原因：輸入修改類型的原因說明
      - 修改後的類型會顯示原因說明，點擊可查看詳情
    - 轉帳金額：轉帳數量
    - 狀態：當前轉帳狀態
    - 交易哈希：區塊鏈交易哈希，支持複製及區塊鏈瀏覽器查看
    - 建立時間：轉帳單建立時間
    - 上鏈時間：交易提交至區塊鏈時間
    - 完成時間：轉帳完成時間

### 兌換訂單查詢
- **查詢條件**：
  - 訂單編號：支持輸入兌換單號進行查詢
  - 商戶：下拉選擇商戶進行篩選
  - 幣鏈：下拉選擇幣鏈進行篩選
  - 兌換幣種：支持選擇兌出/兌入幣種組合
  - 狀態：下拉選擇訂單狀態
    - 處理中(processing)：兌換正在處理
    - 成功(success)：兌換已完成
    - 失敗(failed)：兌換失敗
  - 時間範圍：支持選擇建立時間區間查詢
- **列表展示**：
  - 支持分頁查詢，每頁10筆資料
  - 支持匯出CSV功能
  - 欄位說明：
    - 訂單編號：系統兌換單號
    - 兌出錢包：錢包ID
    - 兌出幣種：兌換前的幣種
    - 兌出金額：兌換前的金額
    - 兌出轉帳單時間資訊：包含該筆轉帳單的創建、上鏈、完成時間
    - 兌出轉帳單號
    - 目標交易所
    - 兌換匯率：交易所內兌換時的USDT單價
    - 兌入錢包：錢包ID
    - 兌入幣種：兌換前的幣種
    - 兌入金額：兌換前的金額
    - 兌入轉帳單時間資訊：包含該筆轉帳單的創建、上鏈、完成時間
    - 兌入轉帳單號
    - 手續費：交易所提幣時所扣除的費用
    - 手續費價值：記錄交易所完成提幣時，當前匯率
    - 建立時間：訂單建立時間
    - 完成時間：兌換完成時間
    - 狀態：請參考[代幣兌換](#代-幣-兌-換)

### 交易明細查詢
  - **查詢條件**：
    - 時間範圍：選擇交易時間區間
    - 鏈類型：選擇區塊鏈網絡類型
    - 幣種：選擇代幣類型
    - 來源地址/目標地址：輸入完整地址進行查詢
    - 商戶：選擇特定商戶
    - 交易哈希：輸入txhash查詢
    - 狀態：成功 / 確認中 / 失敗
  - **列表展示**：
    - 支持分頁查詢，每頁20筆資料
    - 欄位說明：
      - 交易ID：唯一識別碼(如:TX202403150001)
      - 鏈類型：區塊鏈類型(ETH/BTC/TRON等)
      - 幣種：代幣類型(USDT/BTC/ETH等)
      - 轉出資訊：
        - 錢包地址：顯示縮略地址(前4後4位)，支持複製
        - 錢包ID：若有關聯錢包則顯示
      - 轉入資訊：
        - 錢包地址：顯示縮略地址(前4後4位)，支持複製
        - 錢包ID：若有關聯錢包則顯示
      - 交易哈希：顯示縮略哈希(前6後6位)，支持複製及區塊鏈瀏覽器查看
      - 手續費：顯示手續費幣種及數量
      - 狀態：
        - 成功(success)：交易已完成
        - 確認中(confirming)：顯示確認數
        - 失敗(failed)：交易失敗
      - 上鏈時間：交易提交至區塊鏈時間
      - 確認時間：交易完成確認時間
### 訂單編號組成
  - 充值訂單編號：{DE}{YYYYMMDD}{6位流水號}
  - 提幣訂單編號：{WD}{YYYYMMDD}{6位流水號}
  - 兌換訂單號號：{EX}{YYYYMMDD}{6位流水號}
  - 轉帳訂單編號：{TR}{YYYYMMDD}{6位流水號}
  - 交易明細編號：{TX}{YYYYMMDD}{6位流水號}
  
## 對帳管理
- **錢包餘額對帳**：自動化對帳功能
  - **查詢條件**：
    - 對帳日期：選擇對帳日期
    - 商戶：選擇特定商戶
    - 錢包ID：輸入錢包ID進行查詢
    - 鏈類型：選擇區塊鏈網絡類型
    - 幣種：選擇代幣類型
    - 對帳狀態：成功/失敗
  - **列表展示**：
    - 支持分頁查詢，每頁20筆資料
    - 欄位說明：
      - 對帳日期：執行對帳的日期
      - 商戶：關聯商戶名稱
      - 錢包ID：錢包唯一識別碼
      - 鏈類型：區塊鏈類型(ETH/BTC/TRON等)
      - 幣種：代幣類型(USDT/BTC/ETH等)
      - 餘額：當前錢包餘額
      - 對帳狀態：成功/失敗
  - **對帳明細**：
    - 期初餘額：對帳日期開始時的餘額
    - 轉出總額：當日所有轉出交易金額
    - 轉入總額：當日所有轉入交易金額
    - 理論餘額：期初餘額 - 轉出總額 + 轉入總額
    - 實際餘額：區塊鏈上實際查詢到的餘額
    - 差額：理論餘額與實際餘額的差異
    - 轉帳明細：顯示當日所有轉帳記錄
      - 轉帳ID：轉帳單號
      - 來源錢包：轉出方錢包ID
      - 目標錢包：轉入方錢包ID
      - 轉帳類型：fee/deposit/withdrawal/collection/pending等
      - 轉帳金額：交易金額(負數表示轉出)
      - 交易哈希：區塊鏈交易哈希
      - 建立時間：轉帳單建立時間
    - 重新對帳：針對該筆對帳的時間範圍內資料，重新進行比對
  - **對帳說明**
    - 每日12點後記錄各錢包餘額，並針對該日錢包的轉帳單入出金額比行比對
    - 若 前日餘額 + 今日轉入 - 今日轉出 ≠ 今日餘額，則對帳狀態為對帳失敗，反之則成功

## 數據報表
### 充提時長報表：分析充提幣效率
  - **查詢條件**：
    - 日期範圍：選擇查詢時間範圍
    - 商戶：選擇特定商戶
  - **列表展示**：
    - 存款數據表格：
      - 鏈類型：區塊鏈網絡類型
      - 交易筆數：該鏈上存款交易總數
      - 平均處理時長：該鏈上存款平均處理時間
    - 提款數據表格：
      - 鏈類型：區塊鏈網絡類型 
      - 交易筆數：該鏈上提款交易總數
      - 平均處理時長：該鏈上提款平均處理時間
    - 幣種明細表格：
      - 幣種：代幣類型
      - 交易筆數：該幣種交易總數
      - 交易金額：該幣種交易總額
      - 平均處理時長：該幣種平均處理時間
  - **圖表分析**：
    - 支持查看各鏈類型的處理時長趨勢圖
    - X軸為日期，Y軸為平均處理時長
    - 可切換查看存款或提款數據

### 錢包盈虧查詢**：分析錢包資產變化
  - **查詢條件**：
    - 日期範圍：選擇查詢時間範圍
    - 錢包ID：輸入錢包ID進行查詢
    - 錢包地址：輸入錢包地址進行查詢
    - 錢包類型：選擇錢包類型
    - 鏈類型：選擇區塊鏈網絡類型
    - 幣種：選擇代幣類型
  - **列表展示**：
    - 日期：資料統計日期
    - 商戶：所屬商戶
    - 錢包ID：錢包唯一識別碼
    - 鏈類型：區塊鏈類型
    - 幣種：代幣類型
    - 平均成本：持倉平均成本
    - 持倉成本：總持倉成本
      - 顯示漲跌幅百分比
      - 上升顯示綠色箭頭
      - 下降顯示紅色箭頭
    - 當前價格：當前市場價格
    - 市值：當前市場價值
      - 顯示漲跌幅百分比
      - 上升顯示綠色箭頭
      - 下降顯示紅色箭頭
    - 錢包餘額：當前錢包餘額
    - 詳情：查看歷史走勢圖
  - **走勢圖**：
    - 支持7天、30天、90天時間範圍切換
    - 以折線圖呈現市值變化趨勢
    - X軸為日期
    - Y軸為市值金額
  - **錢包盈虧數據生成說明**
    - 以每日12點為基準，記錄數據及前一日的對比
    - 只統計錢包類型為：歸集錢包、提款錢包

### 節點高度分析：分析節點同步情況
- **查詢條件**：
  - 日期範圍：選擇查詢時間範圍
  - 鏈類型：選擇區塊鏈網絡類型
- **圖表展示**：
  - 折線圖呈現搜搜條件內節點高度變化趨勢
  - X軸為日期
  - Y軸為節點高度差值
  - 支持圖表縮放
  - 支持數據重新整理
  - 圖表特性：
    - 平滑曲線
    - 區域漸層填充
    - 數據點提示框
    - 自適應容器大小

## 參數管理
### **區塊鏈管理**：管理支持的區塊鏈
- **合約幣種管理**：管理支持的代幣

## 系統管理
- **用戶管理**：系統用戶管理
- **角色管理**：權限角色管理
- **商戶管理**：商戶信息管理

## 技術架構

### 前端技術棧
- Vue 3
- Ant Design Vue
- Vue Router
- Vite
- TypeScript

### 後端技術棧
- Node.js
- Express
- MongoDB
- Redis

### 區塊鏈集成
- Web3.js
- Ethers.js

## 部署要求

### 硬件要求
- CPU: 8核心以上
- 內存: 16GB以上
- 硬碟: 500GB以上 SSD

### 軟件要求
- Node.js 16+
- MongoDB 4.4+
- Redis 6+
- Docker 20+

## 安全措施

### 數據安全
- 數據加密存儲
- 定期數據備份
- 敏感信息脫敏

### 訪問安全
- 多因素認證
- IP白名單
- 操作日誌記錄

### 錢包安全
- 多重簽名
- 冷熱錢包分離
- 私鑰加密存儲

## 更新日誌

### v1.0.0 (2024-03-20)
- 初始版本發布
- 基礎功能實現

### v1.0.1 (2024-03-21)
- 修復已知問題
- 優化用戶體驗
- 提升系統穩定性 

